<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Leaf Disease Prediction</title>
    
    

    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Navigation Bar */
        .navbar-custom {
            background: linear-gradient(135deg, #1b4d45 0%, #173f38 50%, #132f2a 100%);
            padding: 16px 30px;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 8px 30px rgba(2, 6, 23, 0.6);
            backdrop-filter: blur(6px);
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand {
            font-size: 28px;
            font-weight: 700;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-brand:hover {
            color: #e8f5e9;
        }

        .nav-menu {
            display: flex;
            gap: 30px;
            list-style: none;
        }

        .nav-menu a {
            color: rgba(230, 238, 246, 0.95);
            text-decoration: none;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.25s ease;
            position: relative;
            padding-bottom: 5px;
            letter-spacing: 0.2px;
        }

        .nav-menu a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background-color: #38b2ac; /* accent */
            transition: width 0.25s ease;
        }

        .nav-menu a:hover::after {
            width: 100%;
        }

        .nav-menu a:hover {
            color: rgba(255,255,255,0.95);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) translateX(0px); }
            50% { transform: translateY(30px) translateX(10px); }
        }

        @keyframes float-reverse {
            0%, 100% { transform: translateY(0px) translateX(0px); }
            50% { transform: translateY(-30px) translateX(-10px); }
        }

        @keyframes rotate-float {
            0% { transform: rotate(0deg) translateY(0px); }
            50% { transform: rotate(10deg) translateY(20px); }
            100% { transform: rotate(0deg) translateY(0px); }
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(180deg, #062323 0%, #051d1d 60%);
            color: #e9f0f0;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            padding-top: 80px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .content-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 80px);
            width: 100%;
            padding: 20px;
            background: rgba(6, 18, 16, 0.24); /* slightly lighter overlay */
            border-radius: 8px;
            transition: background 0.25s ease;
        }

        body::before {
            content: 'üçÉ';
            position: fixed;
            font-size: 80px;
            opacity: 0.25;
            top: 10%;
            left: 5%;
            animation: float 7s ease-in-out infinite;
            pointer-events: none;
        }

        body::after {
            content: 'üçÉ';
            position: fixed;
            font-size: 100px;
            opacity: 0.25;
            bottom: 15%;
            right: 8%;
            animation: float-reverse 8s ease-in-out infinite;
            pointer-events: none;
        }

        .container {
            background: rgba(83, 97, 106, 0.88);
            border-radius: 14px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
            padding: 40px 32px;
            width: 100%;
            max-width: 900px;
            text-align: center;
            position: relative;
            z-index: 1;
            border: 1px solid rgba(255, 255, 255, 0.045);
            backdrop-filter: blur(6px);
            transition: all 0.25s ease;
        }

        #home {
            max-width: fit-content;
            padding: 40px 30px;
            width: auto;
        }

        /* Ensure Home page text is readable on the current theme */
        #home, #home h1, #home p, #home .feature-intro, #home strong, #home .title {
            color: var(--text-dark);
        }

        #home p { color: var(--text-dark); }

        /* Supported crops label */
        #home h2 { color: var(--text-dark); }

        .home-wrapper {
            display: flex;
            gap: 40px;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 1100px;
            min-height: auto;
        }

        .home-container {
            background: rgba(10, 18, 24, 0.72);
            border-radius: 12px;
            box-shadow: 0 12px 30px rgba(2, 6, 12, 0.6);
            padding: 40px 32px;
            width: 100%;
            max-width: 500px;
            text-align: center;
            position: relative;
            z-index: 1;
            border: 1px solid rgba(255,255,255,0.03);
            flex-shrink: 0;
        }

        /* Diagnostics panel: light, near-white opaque box */
        #diagnostics.container, .container#diagnostics {
            background: rgba(250, 255, 252, 0.78) !important;
            border: 1px solid rgba(8, 80, 70, 0.06) !important;
            box-shadow: 0 14px 30px rgba(6, 28, 22, 0.06);
            padding: 36px 28px;
            backdrop-filter: blur(4px) saturate(1.02);
            color: #063233; /* default text inside diagnostics */
        }

        /* Ensure headings and paragraphs inside diagnostics are dark for contrast */
        #diagnostics .title,
        #diagnostics h1,
        #diagnostics h2 {
            color: #063233;
        }

        #diagnostics p,
        #diagnostics label,
        #diagnostics .file-name {
            color: rgba(6,50,51,0.95);
        }

        /* Make the file-label lighter with dark text inside diagnostics */
        #diagnostics .file-label {
            background-color: #4e9c7c45;
            color: #063233;
            border-color: rgba(6,120,95,0.12);
        }

        .home-icons {
            display: flex;
            flex-direction: column;
            gap: 30px;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            width: auto;
        }

        .icon-card {
            background: rgba(255,255,255,0.03);
            border-radius: 15px;
            padding: 30px;
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            box-shadow: 0 6px 18px rgba(2, 6, 23, 0.5);
            border: 1px solid rgba(255,255,255,0.03);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .icon-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(76, 175, 80, 0.25);
            border-color: #4CAF50;
        }

        .icon-label {
            font-size: 14px;
            font-weight: 600;
            color: #e6eef6;
            margin-top: 8px;
            text-align: center;
        }

        .crop-icons-container {
            display: flex;
            gap: 30px;
            justify-content: center;
            margin-top: 40px;
            flex-wrap: wrap;
        }

        .crop-icon-item {
            position: relative;
            text-align: center;
            cursor: pointer;
        }

        .crop-icon {
            width: 48px;
            height: 48px;
            background: transparent;
            border-radius: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: none;
            border: none;
            transition: transform 0.25s ease, box-shadow 0.25s ease;
            overflow: visible;
            padding: 0;
        }

        .crop-icon:hover {
            transform: translateY(-6px) scale(1.06);
        }

        .crop-photo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .crop-emoji {
            font-size: 28px;
            line-height: 1;
            display: inline-block;
        }

        /* Supported crops horizontal layout */
        .supported-row {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 12px;
            margin-top: 20px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .supported-text {
            flex: 0 0 auto;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .supported-icons {
            flex: 0 0 auto;
            display: flex;
            justify-content: flex-start;
            gap: 12px;
            align-items: center;
            margin-left: 20px; /* nudged slightly right */
        }

        @media (max-width: 640px) {
            .supported-row {
                flex-direction: column;
                align-items: flex-start;
            }
            .supported-icons {
                justify-content: flex-start;
                margin-left: 0;
            }
        }

        .crop-info {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            margin-bottom: 8px;
            font-weight: 500;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .crop-info::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #4CAF50;
        }

        .crop-icon-item:hover .crop-info {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-5px);
        }

        .crop-name {
            font-size: 14px;
            font-weight: 600;
            color: #e6eef6;
            margin-top: 8px;
        }

        /* Home Page Enhanced Animations */
        .title {
            animation: titlePulse 3s ease-in-out infinite;
        }

        @keyframes titlePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .feature-list li {
            animation: slideInLeft 0.6s ease-out forwards;
            opacity: 0;
        }

        .feature-list li:nth-child(1) { animation-delay: 0.1s; }
        .feature-list li:nth-child(2) { animation-delay: 0.2s; }
        .feature-list li:nth-child(3) { animation-delay: 0.3s; }
        .feature-list li:nth-child(4) { animation-delay: 0.4s; }

        @keyframes slideInLeft {
            from {
                transform: translateX(-30px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .cta-button {
            display: inline-block;
            margin-top: 25px;
            padding: 14px 32px;
            background: linear-gradient(135deg, #06b6d4 0%, #0ea5a4 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            box-shadow: 0 6px 20px rgba(6, 182, 212, 0.18);
            opacity: 0.9;
        }

        .cta-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(6, 182, 212, 0.25);
            background: linear-gradient(135deg, #0b94a0 0%, #077f78 100%);
        }

        .cta-button:active {
            transform: translateY(-1px);
        }

        .feature-intro {
            display: inline-block;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            animation: fadeInUp 0.8s ease-out;
        }

        @keyframes fadeInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .stat-card {
            background: white;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.1);
            margin: 15px;
            display: inline-block;
            transition: all 0.3s ease;
            border-left: 4px solid #4CAF50;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.25);
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: #4CAF50;
        }

        .stat-label {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .title {
            font-size: 32px;
            font-weight: 700;
            color: #e6eef6;
            margin-bottom: 40px;
            letter-spacing: -0.5px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type="file"] {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 15px 30px;
            background-color: #f0f0f0;
            color: #04332c; /* darker font for better readability */
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px dashed #4CAF50;
            width: 100%;
            box-sizing: border-box;
        }

        /* layout for label + upload button */
        .file-input-row { display: flex; gap: 10px; align-items: center; }
        .file-label { flex: 1; }

        .upload-btn {
            padding: 10px 14px;
            background: linear-gradient(90deg,#16a34a,#059669);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            box-shadow: 0 6px 18px rgba(5,86,64,0.08);
            transition: transform 0.12s ease, box-shadow 0.12s ease;
        }

        .upload-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 26px rgba(5,86,64,0.12); }

        .file-label:hover {
            background-color: #e8f5e9;
            border-color: #45a049;
            transform: translateY(-2px);
            color: #04332c;
        }

        .file-name {
            display: block;
            margin-top: 10px;
            font-size: 13px;
            color: #999;
            font-style: italic;
        }

        .file-name.selected {
            color: #4CAF50;
            font-style: normal;
            font-weight: 500;
        }

        .submit-btn {
            display: inline-block;
            width: auto;
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.18s ease;
            text-transform: none;
            white-space: nowrap;
            min-width: 120px;
            margin-top: 12px;
        }

        .submit-btn:hover {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .file-input-wrapper.drag-over {
            background-color: #e8f5e9;
            border-color: #45a049;
        }
        .modal-content {
            border: none;
            border-radius: 12px;
            box-shadow: 0 18px 40px rgba(6, 24, 20, 0.06);
            background: rgba(255,255,255,0.98);
            color: #04332c;
        }

        .modal-header {
            background: linear-gradient(135deg, #8fd3c4 0%, #6fc0ad 100%);
            color: #04332c;
            border-bottom: none;
            border-radius: 12px 12px 0 0;
        }

        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }

        .modal-title {
            font-weight: 700;
            font-size: 24px;
        }

        .modal-body {
            padding: 28px;
        }

        /* Slightly constrain modal max width for comfortable viewing */
        .modal-dialog { max-width: 640px; }

        .modal-image {
            max-width: 100%;
            max-height: 380px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .result-info {
            background: rgba(255,255,255,0.02);
            padding: 18px;
            border-radius: 10px;
            border-left: 4px solid #38b2ac;
            margin-bottom: 20px;
        }

        .result-label {
            font-size: 12px;
            color: #063233; /* darker for better readability */
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .result-value {
            font-size: 28px;
            font-weight: 700;
            color: #7ee7c7;
            margin-bottom: 20px;
        }

        .confidence-label {
            font-size: 13px;
            color: #063233; /* darker for better readability */
            margin-bottom: 6px;
            font-weight: 600;
        }

        .progress {
            height: 8px;
            max-width: 220px;
            margin-left: auto;
            margin-right: auto;
            border-radius: 5px;
            background-color: #e0e0e0;
            margin-bottom: 8px;
        }

        .progress-bar {
            background: linear-gradient(90deg, #4CAF50 0%, #2e7d32 100%);
        }

        .confidence-percent {
            font-size: 13px;
            font-weight: 700;
            color: #2e7d32;
            margin-top: 6px;
        }

        /* Diagnosis status icon (healthy vs disease) - smaller and tighter to text */
        .status-icon {
            width: 14px;
            height: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 9px;
            line-height: 1;
            margin-left: 1px;
            padding: 0;
        }

        .status-success {
            background: #ecfbf2; /* even lighter pale green */
            color: #059669;
            border: 1px solid #34d399;
        }

        .status-fail {
            background: #fff6f6; /* lighter pale red */
            color: #9f1a1a;
            border: 1px solid #fca5a5;
        }

        .modal-footer {
            border-top: 1px solid #e8eef5;
            padding: 20px 30px;
            gap: 10px;
        }

        .btn-analyze {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border: none;
            color: white;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .btn-analyze:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
            color: white;
        }

        /* Additional leaf decorations */
        .leaf-1 {
            position: fixed;
            font-size: 70px;
            opacity: 0.60;
            top: 20%;
            right: 10%;
            animation: rotate-float 6s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-2 {
            position: fixed;
            font-size: 90px;
            opacity: 0.60;
            bottom: 25%;
            left: 5%;
            animation: float 9s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-3 {
            position: fixed;
            font-size: 60px;
            opacity: 0.60;
            top: 30%;
            left: 18%;
            animation: float-reverse 7.5s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-4 {
            position: fixed;
            font-size: 75px;
            opacity: 0.25;
            bottom: 10%;
            right: 15%;
            animation: rotate-float 8.5s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-5 {
            position: fixed;
            font-size: 65px;
            opacity: 0.25;
            top: 50%;
            right: 3%;
            animation: float 6.5s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-6 {
            position: fixed;
            font-size: 80px;
            opacity: 0.25;
            top: 15%;
            left: 20%;
            animation: float-reverse 9.5s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-7 {
            position: fixed;
            font-size: 55px;
            opacity: 0.25;
            top: 60%;
            left: 12%;
            animation: rotate-float 7s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-8 {
            position: fixed;
            font-size: 70px;
            opacity: 0.60;
            bottom: 40%;
            right: 5%;
            animation: float 8s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-9 {
            position: fixed;
            font-size: 85px;
            opacity: 0.25;
            top: 25%;
            right: 25%;
            animation: float-reverse 10s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-10 {
            position: fixed;
            font-size: 65px;
            opacity: 0.25;
            bottom: 30%;
            left: 25%;
            animation: rotate-float 9s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-11 {
            position: fixed;
            font-size: 75px;
            opacity: 0.25;
            top: 40%;
            left: 3%;
            animation: float 7.5s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-12 {
            position: fixed;
            font-size: 60px;
            opacity: 0.25;
            bottom: 50%;
            right: 20%;
            animation: float-reverse 8.5s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-13 {
            position: fixed;
            font-size: 70px;
            opacity: 0.60;
            top: 60%;
            left: 50%;
            animation: rotate-float 9.5s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-14 {
            position: fixed;
            font-size: 80px;
            opacity: 0.25;
            top: 5%;
            right: 30%;
            animation: float 10.5s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-15 {
            position: fixed;
            font-size: 65px;
            opacity: 0.25;
            bottom: 7%;
            left: 58%;
            animation: float-reverse 9s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-16 {
            position: fixed;
            font-size: 75px;
            opacity: 0.25;
            top: 55%;
            right: 8%;
            animation: rotate-float 8s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-17 {
            position: fixed;
            font-size: 60px;
            opacity: 0.25;
            bottom: 45%;
            left: 8%;
            animation: float 7s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-18 {
            position: fixed;
            font-size: 90px;
            opacity: 0.25;
            top: 35%;
            right: 2%;
            animation: float-reverse 11s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-19 {
            position: fixed;
            font-size: 70px;
            opacity: 0.25;
            bottom: 20%;
            right: 35%;
            animation: rotate-float 8.5s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-20 {
            position: fixed;
            font-size: 65px;
            opacity: 0.25;
            top: 80%;
            left: 15%;
            animation: float 9.5s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-21 {
            position: fixed;
            font-size: 70px;
            opacity: 0.25;
            top: 12%;
            right: 45%;
            animation: rotate-float 7.5s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-22 {
            position: fixed;
            font-size: 75px;
            opacity: 0.25;
            bottom: 35%;
            right: 25%;
            animation: float 8.5s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-23 {
            position: fixed;
            font-size: 60px;
            opacity: 0.25;
            top: 45%;
            right: 40%;
            animation: float-reverse 9.5s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-24 {
            position: fixed;
            font-size: 80px;
            opacity: 0.25;
            bottom: 15%;
            left: 30%;
            animation: rotate-float 10s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-25 {
            position: fixed;
            font-size: 65px;
            opacity: 0.25;
            top: 22%;
            left: 40%;
            animation: float 6.5s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-26 {
            position: fixed;
            font-size: 75px;
            opacity: 0.25;
            bottom: 60%;
            right: 40%;
            animation: float-reverse 7.5s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-27 {
            position: fixed;
            font-size: 70px;
            opacity: 0.25;
            top: 65%;
            right: 28%;
            animation: rotate-float 9s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-28 {
            position: fixed;
            font-size: 85px;
            opacity: 0.25;
            bottom: 8%;
            right: 45%;
            animation: float 10s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-29 {
            position: fixed;
            font-size: 60px;
            opacity: 0.25;
            top: 75%;
            right: 50%;
            animation: float-reverse 8.5s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .leaf-30 {
            position: fixed;
            font-size: 75px;
            opacity: 0.25;
            top: 2%;
            left: 50%;
            animation: rotate-float 11s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }
    </style>

    <!-- Modern UI overrides (muted light theme - not too light) -->
    <style>
        :root{
            --bg: #e9f2f1; /* slightly darker than pure white */
            --card: #f7fbfa; /* soft card background */
            --muted: rgba(11,20,32,0.64);
            --accent: #16a34a; /* green accent for natural feel */
            --glass: rgba(11,20,32,0.04);
            --radius: 12px;
            --surface: #f4f8f7;
            --text-light: #0b1220;
            --text-dark: #082028;
            --soft-shadow: 0 10px 30px rgba(11,20,32,0.06);
        }

        /* Use modern font and apply background */
        body, input, button, select, textarea { font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; color:var(--text-dark); background:var(--bg); }

        /* Navbar - subtle tint, not pure white */ 
        .navbar-custom{
            background: linear-gradient(90deg, rgb(121 145 141), rgba(233, 242, 241, 1));
            border-radius: 0 0 10px 10px;
            padding: 12px 28px;
            box-shadow: var(--soft-shadow);
            border-bottom: 1px solid rgba(11,20,32,0.05);
        }

        .nav-brand{ font-weight:700; letter-spacing:0.2px; color:var(--text-dark); }
        .nav-menu a{ color:var(--muted); padding:6px 8px; border-radius:8px; }
        .nav-menu a:hover{ color:var(--text-dark); background: rgba(11,20,32,0.03); }

        /* Layout */
        .content-wrapper{ padding:44px 20px; }
        .container{ background: var(--card); border-radius:var(--radius); padding:24px; box-shadow:0 8px 28px rgba(11,20,32,0.06); border:1px solid rgba(11,20,32,0.04); }

        /* Cards */
        .home-container, .home-wrapper, .icon-card{ border-radius:12px; }

        /* Buttons - green accent */
        .cta-button, .submit-btn, .btn-analyze{ background:linear-gradient(90deg,var(--accent),#059669); color:white; border:none; padding:10px 16px; border-radius:10px; box-shadow: 0 8px 20px rgba(5,86,64,0.06); transition:transform .12s ease, box-shadow .12s ease; }
        .cta-button:hover, .submit-btn:hover, .btn-analyze:hover{ transform:translateY(-3px); box-shadow:0 12px 26px rgba(5,86,64,0.12); }

        /* Spinner animation for analyze button */
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #analyzeSpinner svg { display: inline-block; vertical-align: middle; animation: spin 0.9s linear infinite; }

        /* File input */
        .file-input-wrapper{ width:100%; }
        .file-label{ background:transparent; border:2px dashed rgba(11,20,32,0.06); color:var(--text-dark); padding:16px; border-radius:10px; text-align:center; }
        .file-label:hover{ background: rgba(6,108,128,0.02); color:var(--text-dark); }

        /* Crop icons modern */
        .crop-icon{ width:44px; height:44px; border-radius:8px; display:flex; align-items:center; justify-content:center; background: rgba(11,20,32,0.03); }

        /* Modal - light but with dark text for readability */
        .modal-content{ border-radius:10px; background: linear-gradient(180deg,#fbfdfc,#f7fbfa); color:var(--text-dark); border:1px solid rgba(11,20,32,0.04); box-shadow: 0 30px 80px rgba(11,20,32,0.08); }
        .modal-header{ background:transparent; border-bottom:none; }
        .modal-image{ max-width: 320px; border-radius:8px; border:1px solid rgba(11,20,32,0.04); }

        /* Results */
        .result-info{ background: rgba(22,163,74,0.04); border-left:4px solid var(--accent); padding:14px; margin-top:12px; border-radius:6px; }
        .result-label, .confidence-label{ color: rgba(8,32,40,0.9); font-weight:600; margin-top:8px; }
        .result-value{ color: var(--text-dark); font-size:18px; font-weight:700; margin-top:6px; }

        /* Make Diagnosis (description) prominent but slightly smaller */
        #descriptionResult { font-size: 24px; font-weight: 800; color: var(--text-dark); line-height: 1.1; display:inline-block; margin-right:8px; }
        #plantResult { font-size: 18px; font-weight: 700; color: rgba(8,32,40,0.85); }

        /* Diagnosis info icon and panel */
        .diag-info-btn {
            background: linear-gradient(135deg, rgba(22,163,74,0.12), rgba(22,163,74,0.18));
            border: 1px solid rgba(22,163,74,0.22);
            font-size: 18px;
            cursor: pointer;
            vertical-align: middle;
            color: var(--accent);
            padding: 6px 8px;
            border-radius: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            box-shadow: 0 6px 18px rgba(22,163,74,0.14);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .diag-info-btn:focus { outline: none; box-shadow: 0 8px 20px rgba(22,163,74,0.22); transform: translateY(-2px); }
        .diag-info-btn:hover { transform: translateY(-2px) scale(1.03); }

        .cute-icon { font-size: 18px; line-height: 1; display: inline-block; }

        @keyframes gentle-pulse {
            0% { box-shadow: 0 6px 18px rgba(22,163,74,0.12); }
            50% { box-shadow: 0 12px 28px rgba(22,163,74,0.16); transform: translateY(-1px); }
            100% { box-shadow: 0 6px 18px rgba(22,163,74,0.12); transform: translateY(0); }
        }

        /* make the panel more visible while keeping the title compact */
        .diag-info-panel {
            display: none;
            text-align: left;
            margin-top: 10px;
            background: #ffffff; /* higher contrast */
            border: 1px solid rgba(22,163,74,0.14);
            padding: 12px 14px;
            border-radius: 8px;
            color: var(--text-dark);
            box-shadow: 0 12px 30px rgba(11,20,32,0.06);
            font-size: 14px;
        }

        .diag-info-panel .title {
            font-weight: 800;
            margin-bottom: 6px;
            font-size: 13px; /* smaller but bold for clarity */
            color: var(--text-dark);
            letter-spacing: 0.2px;
        }

        .progress{ height:8px; max-width:220px; margin-left:auto; margin-right:auto; background: rgba(11,20,32,0.04); border-radius:8px; overflow:hidden; }
        .progress-bar{ background: var(--accent); height:100%; }
        .confidence-percent{ color:var(--text-dark); margin-top:6px; font-weight:600; font-size:13px; }

        /* Diagnosis status icon (modern UI) - match smaller sizing */
        .status-icon { width:14px; height:14px; display:inline-flex; align-items:center; justify-content:center; border-radius:50%; font-size:9px; line-height:1; margin-left:1px; padding:0; }
        .status-success { background:#ecfbf2; color:#059669; border:1px solid #34d399; }
        .status-fail { background:#fff6f6; color:#9f1a1a; border:1px solid #fca5a5; }

        /* About page: ensure readable text and lists */
        #about, #about .title, #about h1, #about p, #about ul, #about li, #about strong {
            color: var(--text-dark);
        }

        /* Responsive tweaks */
        @media (max-width:800px){ .home-wrapper{ flex-direction:column; gap:20px; } .nav-menu{ display:none; } }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar-custom">
        <div class="nav-container">
            <a href="#home" class="nav-brand">
                üåø Plant Leaf Disease Detector
            </a>
            <ul class="nav-menu">
                <li><a href="#home">Home</a></li>
                <li><a href="#diagnostics">Diagnostics</a></li>
                <li><a href="#about">About</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content Wrapper -->
    <div class="content-wrapper">
        <!-- Floating leaf decorations - 30 total leaves -->
    <div class="leaf-1">üçÉ</div>
    <div class="leaf-2">üçÉ</div>
    <div class="leaf-3">üçÉ</div>
    <div class="leaf-6">üçÉ</div>
    <div class="leaf-8">üçÉ</div>
    <div class="leaf-9">üçÉ</div>
    <div class="leaf-10">üçÉ</div>
    <div class="leaf-11">üçÉ</div>
    <div class="leaf-12">üçÉ</div>
    <div class="leaf-13">üçÉ</div>
    <div class="leaf-14">üçÉ</div>
    <div class="leaf-15">üçÉ</div>


    <div id="home">
        <h1 class="title">üåø Welcome to Plant Leaf Disease Detector</h1>
        <p style="font-size: 18px; color: #264e39; line-height: 1.8; margin-top: 30px;">
            <span class="feature-intro">Detect plant leaf diseases with AI-powered precision</span>
            <br/><br/>
            <strong style="font-size: 18px; color: var(--text-dark);">Get Started:</strong>
            <br/>
            Click the button below or go to the <strong>Diagnostics</strong> menu to analyze plant leaf images and identify diseases instantly.
            <br/><br/>
            Our advanced machine learning model provides:
            <ul class="feature-list" style="text-align: left; display: inline-block; margin: 20px 0; font-size: 16px;">
                <li>‚úì Real-time disease detection</li>
                <li>‚úì High accuracy predictions</li>
                <li>‚úì Confidence scoring</li>
                <li>‚úì Easy drag & drop interface</li>
            </ul>
        </p>
        <button class="cta-button" onclick="document.querySelectorAll('.nav-menu a').forEach(link => { if(link.getAttribute('href') === '#diagnostics') link.click(); })">üì∏ Start Analyzing</button>

        <!-- Supported Crops Section (text left, icons right) -->
        <div class="supported-row">
            <div class="supported-text">
                <h2 style="font-size: 18px; color: var(--text-dark); margin: 0; font-weight: 600;">Supported Crops</h2>
            </div>

            <div class="supported-icons" aria-label="Supported crop icons">
                <div class="crop-icon-item" title="Tomato">
                    <div class="crop-info">Rich in lycopene and vitamin C</div>
                    <div class="crop-icon">
                        <span class="crop-emoji" aria-hidden="true">üçÖ</span>
                    </div>
                    <div class="crop-name">Tomato</div>
                </div>

                <div class="crop-icon-item" title="Potato">
                    <div class="crop-info">World's most important food crop</div>
                    <div class="crop-icon">
                        <span class="crop-emoji" aria-hidden="true">ü•î</span>
                    </div>
                    <div class="crop-name">Potato</div>
                </div>

                <div class="crop-icon-item" title="Bell Pepper">
                    <div class="crop-info">Available in vibrant rainbow colors</div>
                    <div class="crop-icon">
                        <span class="crop-emoji" aria-hidden="true">ü´ë</span>
                    </div>
                    <div class="crop-name">Bell Pepper</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Modal Popup - Bootstrap -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title" id="resultModalLabel">üåø Analysis Result</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" class="modal-image" src="" alt="Uploaded leaf image">
                    <div class="result-info">
                        <div class="result-label">Diagnosis
                            <button id="diagInfoBtn" class="diag-info-btn" title="Show diagnosis details" aria-label="Show diagnosis details">
                                <svg class="cute-icon" aria-hidden="true" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="12" r="10" fill="#ffffff" stroke="currentColor" stroke-width="1.2"></circle>
                                    <path d="M11 10h2v6h-2z" fill="currentColor"></path>
                                    <circle cx="12" cy="7" r="1" fill="currentColor"></circle>
                                </svg>
                            </button>
                        </div>
                        <div>
                            <div style="display:flex; align-items:center; justify-content:center; gap:1px;">
                                <div class="result-value" id="descriptionResult">Loading...</div>
                                <div id="diagStatusIcon" class="status-icon" aria-hidden="true" title="Diagnosis status"></div>
                            </div>
                            <div id="diagInfo" class="diag-info-panel" aria-hidden="true">
                                <div class="title">Diagnosis details</div>
                                <div id="diagExplain">Loading...</div>
                                <div style="margin-top:8px;"><strong>Suggested Cure:</strong> <span id="diagCure">Loading...</span></div>
                            </div>
                        </div>

                        <div class="result-label" style="margin-top:8px;">Plant</div>
                        <div class="result-value" id="plantResult">Loading...</div>

                        <div class="confidence-label">Confidence Level</div>
                        <div class="progress">
                            <div class="progress-bar" id="confidenceFill" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="confidence-percent" id="confidencePercent">0%</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-analyze" onclick="downloadResults()">üì• Download Result</button>
                    <button type="button" class="btn btn-analyze" onclick="analyzeAnother()">Analyze Another</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Diagnostics Section -->
    <div class="container" id="diagnostics" style="display:none; margin-top: 20px; max-width: 500px;">
        <h1 class="title">Plant Leaf Disease Diagnostics</h1>
        
        <form method="post" enctype="multipart/form-data" style="margin-top: 30px;">
            <input type="hidden" name="csrfmiddlewaretoken" value="SnYTTDNNdHegOzIwg1neKJb4ppAOYNSC4gOqMUEx7IepTfoxDPurcoHq7yzXsgFc">
            
            <div class="form-group">
                    <div class="file-input-wrapper">
                        <div class="file-input-row">
                            <label for="fileInput" class="file-label">Choose File <br/> or <br/>Drag & Drop an Image</label>
                        </div>
                        <input type="file" id="fileInput" name="image" accept="image/*" required style="display:none;">
                        <span class="file-name" id="fileName">No file chosen</span>
                    </div>
            </div>

            <!-- Image Preview -->
            <div id="previewContainer" style="margin-top: 30px; display: none; text-align: center;">
                <p style="font-size: 14px; color: var(--muted); margin-bottom: 15px;">Preview</p>
                <img id="uploadPreview" src="" alt="Preview" style="max-width: 300px; max-height: 300px; border-radius: 8px; border: 2px solid #4CAF50;">
            </div>

            <div class="form-group">
                    <div style="display:flex; gap:8px; align-items:center; justify-content:center;">
                        <button type="submit" id="analyzeBtn" class="submit-btn">Analyze Image
                            <span id="analyzeSpinner" aria-hidden="true" style="display:none; margin-left:8px;">
                                <svg width="18" height="18" viewBox="0 0 50 50">
                                    <circle cx="25" cy="25" r="20" fill="none" stroke="#fff" stroke-width="4" stroke-linecap="round" stroke-dasharray="31.415,31.415" transform="rotate(0 25 25)"></circle>
                                </svg>
                            </span>
                        </button>
                        <button type="button" id="cancelBtn" class="submit-btn" style="display:none; background:#ef4444;">Cancel</button>
                    </div>
            </div>
        </form>
    </div>

    <!-- About Section -->
    <div class="container" id="about" style="display:none; margin-top: 20px; max-width: 500px;">
        <h1 class="title">About</h1>
        <p style="font-size: 16px; color: 516578; line-height: 1.8; margin-top: 30px;">
            <strong>Plant Leaf Disease Prediction</strong> is an AI-powered web application designed to help farmers and gardeners identify plant diseases quickly and accurately.
            <br/><br/>
            <strong>Model:</strong> This app now uses an EfficientNet-B0 backbone (transfer-learned) as the core image classifier. EfficientNet provides a strong balance of accuracy and compute efficiency for leaf image classification.
            <br/>
            <strong>Input & Preprocessing:</strong> Images are resized to the model's expected input size (typically 224√ó224 for EfficientNet-B0) and use the matching preprocessing (EfficientNet preprocessing: scaling to the range expected by the model). Ensuring the same preprocessing used during training is important for accurate predictions.
            <br/><br/>
            <strong>Key Features:</strong>
            <ul style="text-align: left; display: inline-block; margin: 20px 0;">
                <li>EfficientNet-B0 based classifier (transfer learning)</li>
                <li>Real-time disease detection</li>
                <li>Drag & Drop image upload and diagnostics</li>
                <li>Confidence scoring and top-k predictions</li>
                <li>User-friendly interface</li>
            </ul>
            <br/>
            <strong>Dataset Used:</strong> <a href="https://www.kaggle.com/datasets/emmarex/plantdisease" target="_blank" rel="noopener noreferrer">Kaggle ‚Äî emmarex / plantdisease</a>
            <br/>
            <small style="color: #6b7280;">The dataset contains labeled leaf images for tomato, potato and bell pepper diseases.</small>
            <br/>
            <small style="color: #6b7280; display:block; margin-top:8px;"><strong>Lecturer:</strong> Farah Younas</small>
            <small style="color: #6b7280; display:block;"><strong>Students:</strong> Mary Miller, Sumitha Naik &amp; Richa Arora</small>
        </p>
    </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Navigation menu functionality
        document.querySelectorAll('.nav-menu a').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('href');
                
                // Hide all sections
                document.getElementById('home').style.display = 'block';
                document.getElementById('diagnostics').style.display = 'none';
                document.getElementById('about').style.display = 'none';
                
                // Show selected section
                if (targetId === '#diagnostics') {
                    document.getElementById('diagnostics').style.display = 'block';
                    document.getElementById('home').style.display = 'none';
                } else if (targetId === '#about') {
                    document.getElementById('about').style.display = 'block';
                    document.getElementById('home').style.display = 'none';
                }
            });
        });

        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const form = document.querySelector('form');
        const resultModalElement = document.getElementById('resultModal');
        const resultModal = new bootstrap.Modal(resultModalElement);
        // Last parsed values for use in download
        let lastPlant = '';
        let lastDescription = '';
        // Inline SVG icons for status (keeps styling via .status-success / .status-fail)
        const SVG_CHECK = `
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`;
        const SVG_X = `
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`;

        function toTitleCase(str) {
            return str.split(' ').map(s => s ? s.charAt(0).toUpperCase() + s.slice(1).toLowerCase() : '').join(' ');
        }

        function parsePredictionLabel(rawLabel) {
            if (!rawLabel) return { plant: 'Unknown', description: '' };
            // Split on one or more underscores
            const parts = rawLabel.split(/_+/).filter(Boolean);
            if (parts.length === 0) return { plant: rawLabel, description: '' };

            const first = parts[0].toLowerCase();
            let plant = '';
            let descParts = [];

            if (first === 'pepper') {
                // Expect tokens like: Pepper, bell, , , Bacterial, spot
                if (parts[1] && parts[1].toLowerCase() === 'bell') {
                    plant = 'Bell Pepper';
                    descParts = parts.slice(2);
                } else {
                    plant = 'Pepper';
                    descParts = parts.slice(1);
                }
            } else if (first === 'tomato' || first === 'potato') {
                plant = first.charAt(0).toUpperCase() + first.slice(1);
                descParts = parts.slice(1);
            } else {
                // Fallback: treat first token as plant and rest as description
                plant = parts[0].charAt(0).toUpperCase() + parts[0].slice(1);
                descParts = parts.slice(1);
            }

            let description = descParts.join(' ').replace(/\s+/g, ' ').trim();
            description = toTitleCase(description);

            return { plant: plant || 'Unknown', description };
        }

        function getDiagnosisInfo(plant, description) {
            // Simple mapping of common diagnosis keywords to explanations and suggested cures.
            const desc = (description || '').toLowerCase();
            const info = { explain: '', cure: '' };

            if (!desc || desc === '‚Äî' || desc === 'n/a') {
                info.explain = 'No diagnosis details provided.';
                info.cure = 'No action needed or consult an expert.';
                return info;
            }

            if (desc.includes('bacterial') || desc.includes('bacterial spot')) {
                info.explain = `${description} is a bacterial infection affecting leaves.`;
                info.cure = 'Remove infected leaves, improve air circulation, and apply copper-based bactericide as recommended.';
            } else if (desc.includes('early blight') || desc.includes('late blight') || desc.includes('blight')) {
                info.explain = `${description} is a fungal disease that causes leaf spots and defoliation.`;
                info.cure = 'Remove affected foliage, avoid overhead watering, and use a suitable fungicide; rotate crops.';
            } else if (desc.includes('healthy')) {
                info.explain = 'The leaf appears healthy.';
                info.cure = 'No treatment required. Continue good cultural practices.';
            } else if (desc.includes('spot') || desc.includes('leaf spot')) {
                info.explain = `${description} causes spots on leaves which may reduce plant vigor.`;
                info.cure = 'Remove badly affected leaves, improve watering practices, and consider fungicide if widespread.';
            } else {
                info.explain = `${description} detected for ${plant}.`; 
                info.cure = 'Refer to local extension guidance or consult an agronomist for a targeted treatment.';
            }

            return info;
        }

        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                fileName.textContent = e.target.files[0].name;
                fileName.classList.add('selected');
                
                // Show image preview
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('uploadPreview').src = event.target.result;
                    document.getElementById('previewContainer').style.display = 'block';
                };
                reader.readAsDataURL(e.target.files[0]);
            } else {
                fileName.textContent = 'No file chosen';
                fileName.classList.remove('selected');
                document.getElementById('previewContainer').style.display = 'none';
            }
        });

        // The visible file label opens the hidden file input via the `for="fileInput"` attribute.
        // No separate upload button is required.

        // Drag and drop functionality
        const fileWrapper = document.querySelector('.file-input-wrapper');
        const fileLabel = document.querySelector('.file-label');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileWrapper.addEventListener(eventName, preventDefaults, false);
            fileLabel.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            fileWrapper.addEventListener(eventName, highlight, false);
            fileLabel.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            fileWrapper.addEventListener(eventName, unhighlight, false);
            fileLabel.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            fileWrapper.classList.add('drag-over');
            fileLabel.style.backgroundColor = '#e8f5e9';
            fileLabel.style.borderColor = '#45a049';
        }

        function unhighlight(e) {
            fileWrapper.classList.remove('drag-over');
            fileLabel.style.backgroundColor = '#f0f0f0';
            fileLabel.style.borderColor = '#4CAF50';
        }

        // Handle dropped files
        fileWrapper.addEventListener('drop', handleDrop, false);
        fileLabel.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            fileInput.files = files;
            
            // Trigger change event to update display
            const event = new Event('change', { bubbles: true });
            fileInput.dispatchEvent(event);
        }

        // Manage cancelable analyze requests
        let currentAbortController = null;

        const analyzeBtn = document.getElementById('analyzeBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const analyzeSpinner = document.getElementById('analyzeSpinner');

        function setAnalyzingState(isAnalyzing) {
            if (isAnalyzing) {
                if (analyzeBtn) { analyzeBtn.disabled = true; analyzeBtn.setAttribute('aria-busy','true'); }
                if (analyzeSpinner) analyzeSpinner.style.display = 'inline-block';
                if (cancelBtn) cancelBtn.style.display = 'inline-block';
                // prevent changing file during analysis
                if (fileInput) fileInput.disabled = true;
            } else {
                if (analyzeBtn) { analyzeBtn.disabled = false; analyzeBtn.removeAttribute('aria-busy'); }
                if (analyzeSpinner) analyzeSpinner.style.display = 'none';
                if (cancelBtn) cancelBtn.style.display = 'none';
                if (fileInput) fileInput.disabled = false;
            }
        }

        cancelBtn && cancelBtn.addEventListener('click', function() {
            if (currentAbortController) {
                currentAbortController.abort();
            }
            setAnalyzingState(false);
        });

        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!fileInput.files.length) {
                alert('Please select an image');
                return;
            }

            // prepare form data and preview
            const formData = new FormData(form);
            const fileReader = new FileReader();

            fileReader.onload = function(ev) {
                const imageDataUrl = ev.target.result;
                document.getElementById('modalImage').src = imageDataUrl;
            };
            fileReader.readAsDataURL(fileInput.files[0]);

            // Abort previous if any
            if (currentAbortController) {
                try { currentAbortController.abort(); } catch (_) {}
            }

            currentAbortController = new AbortController();
            const signal = currentAbortController.signal;

            setAnalyzingState(true);

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                const response = await fetch(form.action || '/', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': csrfToken },
                    signal,
                    // ensure cookies are sent for CSRF validation on same-origin
                    credentials: 'same-origin'
                });

                // Read response text first (safer for diagnosing non-JSON/empty responses)
                const rawText = await response.text();
                let data = null;
                if (rawText && rawText.trim().length > 0) {
                    try {
                        data = JSON.parse(rawText);
                    } catch (parseErr) {
                        // Non-JSON response; attempt to fetch recent server logs (debug endpoint)
                        try {
                            const dbgResp = await fetch('/debug/render-errors/', { credentials: 'same-origin' });
                            if (dbgResp.ok) {
                                const dbgJson = await dbgResp.json();
                                console.error('Server returned non-JSON response:', rawText.substring(0,1000));
                                console.error('Server debug log (tail):', dbgJson.tail || '(empty)');
                            } else {
                                const dbgText = await dbgResp.text();
                                console.error('Server returned non-JSON response and debug endpoint returned', dbgResp.status, dbgText);
                            }
                        } catch (dbgErr) {
                            console.error('Failed to fetch debug logs:', dbgErr);
                            console.error('Server non-JSON response (first 1000 chars):', rawText.substring(0,1000));
                        }

                        throw new Error(`Invalid JSON response (status ${response.status}): ${rawText.substring(0,1000)}`);
                    }
                } else {
                    // Empty body
                    if (!response.ok) {
                        throw new Error(`Empty response body (status ${response.status}).`);
                    }
                }

                if (data.success) {
                    const raw = data.predicted_class || '';
                    const parsed = parsePredictionLabel(raw);
                    lastPlant = parsed.plant;
                    lastDescription = parsed.description;

                    document.getElementById('plantResult').textContent = parsed.plant || 'Unknown';
                    const descFallback = raw.toLowerCase().includes('healthy') ? 'Healthy' : '';
                    const diagText = parsed.description || descFallback || '‚Äî';
                    const descEl = document.getElementById('descriptionResult');
                    const statusEl = document.getElementById('diagStatusIcon');
                    if (descEl) descEl.textContent = diagText;
                    if (statusEl) {
                        const isHealthy = (diagText || '').toString().toLowerCase().includes('healthy');
                        statusEl.innerHTML = isHealthy ? SVG_CHECK : SVG_X;
                        statusEl.classList.remove('status-success', 'status-fail');
                        statusEl.classList.add(isHealthy ? 'status-success' : 'status-fail');
                        statusEl.setAttribute('aria-label', isHealthy ? 'Healthy' : 'Disease detected');
                        statusEl.setAttribute('aria-hidden', 'false');
                    }

                    const info = getDiagnosisInfo(parsed.plant, parsed.description || descFallback);
                    const diagExplainEl = document.getElementById('diagExplain');
                    const diagCureEl = document.getElementById('diagCure');
                    const diagPanel = document.getElementById('diagInfo');
                    if (diagExplainEl) diagExplainEl.textContent = info.explain;
                    if (diagCureEl) diagCureEl.textContent = info.cure;
                    if (diagPanel) { diagPanel.style.display = 'none'; diagPanel.setAttribute('aria-hidden','true'); }

                    const confidence = parseFloat(data.confidence || 0);
                    document.getElementById('confidenceFill').style.width = confidence + '%';
                    document.getElementById('confidencePercent').textContent = Math.round(confidence) + '%';

                    resultModal.show();
                } else {
                    // show API-level error
                    document.getElementById('plantResult').textContent = 'Error';
                    document.getElementById('descriptionResult').textContent = '';
                    const statusElErr = document.getElementById('diagStatusIcon');
                    if (statusElErr) { statusElErr.innerHTML = SVG_X; statusElErr.classList.remove('status-success'); statusElErr.classList.add('status-fail'); statusElErr.setAttribute('aria-label','Error'); statusElErr.setAttribute('aria-hidden','false'); }
                    document.getElementById('confidenceFill').style.width = '0%';
                    document.getElementById('confidencePercent').textContent = 'Error';

                    const errorMsg = data.error || 'Prediction failed';
                    const errorElement = document.createElement('div');
                    errorElement.style.cssText = 'color: #dc3545; padding: 10px; margin-top: 10px; border-radius: 5px; background-color: #f8d7da; border: 1px solid #f5c6cb;';
                    errorElement.textContent = 'Error: ' + errorMsg;

                    const resultDiv = document.getElementById('plantResult').parentElement;
                    if (resultDiv) {
                        const existingError = resultDiv.querySelector('div[style*="dc3545"]');
                        if (existingError) existingError.remove();
                        resultDiv.appendChild(errorElement);
                    }

                    resultModal.show();
                }
            } catch (error) {
                // Handle abort specially to avoid noisy error UI
                if (error && error.name === 'AbortError') {
                    console.log('Analysis request was aborted by user.');
                    // Optionally show a small toast or leave UI as-is; we'll clear analyzing state.
                } else {
                    console.error('Error:', error);
                    document.getElementById('plantResult').textContent = 'Connection Error';
                    document.getElementById('descriptionResult').textContent = '';
                    const statusElCatch = document.getElementById('diagStatusIcon');
                    if (statusElCatch) { statusElCatch.innerHTML = SVG_X; statusElCatch.classList.remove('status-success'); statusElCatch.classList.add('status-fail'); statusElCatch.setAttribute('aria-label','Connection Error'); statusElCatch.setAttribute('aria-hidden','false'); }
                    document.getElementById('confidenceFill').style.width = '0%';
                    document.getElementById('confidencePercent').textContent = 'Error';

                    const errorMsg = (error && error.message) ? error.message : String(error);
                    const errorElement = document.createElement('div');
                    errorElement.style.cssText = 'color: #dc3545; padding: 10px; margin-top: 10px; border-radius: 5px; background-color: #f8d7da; border: 1px solid #f5c6cb;';
                    errorElement.textContent = 'Connection Error: ' + errorMsg;

                    const resultDiv = document.getElementById('plantResult').parentElement;
                    if (resultDiv) {
                        const existingError = resultDiv.querySelector('div[style*="dc3545"]');
                        if (existingError) existingError.remove();
                        resultDiv.appendChild(errorElement);
                    }

                    resultModal.show();
                }
            } finally {
                // cleanup state
                currentAbortController = null;
                setAnalyzingState(false);
            }
        });

        // Toggle diagnosis info panel when icon clicked
        document.addEventListener('click', function(e) {
            const btn = e.target.closest && e.target.closest('#diagInfoBtn');
            if (!btn) return;
            const panel = document.getElementById('diagInfo');
            if (!panel) return;
            const isHidden = panel.getAttribute('aria-hidden') === 'true' || panel.style.display === 'none';
            panel.style.display = isHidden ? 'block' : 'none';
            panel.setAttribute('aria-hidden', isHidden ? 'false' : 'true');
        });

        function analyzeAnother() {
            resultModal.hide();
            fileInput.value = '';
            fileName.textContent = 'No file chosen';
            fileName.classList.remove('selected');
            // Clear last prediction values and reset modal fields
            lastPlant = '';
            lastDescription = '';
            const pEl = document.getElementById('plantResult');
            const dEl = document.getElementById('descriptionResult');
            // Show Diagnosis placeholder first, then Plant
            if (dEl) dEl.textContent = 'No result';
            if (pEl) pEl.textContent = '‚Äî';
            // clear status icon
            const statusElClear = document.getElementById('diagStatusIcon');
            if (statusElClear) { statusElClear.innerHTML = ''; statusElClear.classList.remove('status-success','status-fail'); statusElClear.setAttribute('aria-hidden','true'); }
            // hide diag panel if visible
            const diagPanel = document.getElementById('diagInfo');
            if (diagPanel) { diagPanel.style.display = 'none'; diagPanel.setAttribute('aria-hidden','true'); }
        }
        function downloadResults() {
            // Use last parsed plant/description (fall back to modal text if needed)
            const plant = lastPlant || (document.getElementById('plantResult') && document.getElementById('plantResult').textContent) || 'Unknown';
            let description = lastDescription || (document.getElementById('descriptionResult') && document.getElementById('descriptionResult').textContent) || '';

            // Normalize values
            const descNormalized = (description || '').replace(/\s+/g, ' ').trim();
            const descFallback = descNormalized && descNormalized !== '‚Äî' ? descNormalized : (plant.toLowerCase().includes('healthy') ? 'Healthy' : 'N/A');
            const confidence = document.getElementById('confidencePercent') ? document.getElementById('confidencePercent').textContent : 'N/A';
            const timestamp = new Date().toLocaleString();

            // Get diagnosis explanation and suggested cure from existing helper
            const info = (typeof getDiagnosisInfo === 'function') ? getDiagnosisInfo(plant, descFallback) : { explain: '', cure: '' };
            const explainText = (info && info.explain) ? info.explain : 'N/A';
            const cureText = (info && info.cure) ? info.cure : 'N/A';

            // Build the report content (Diagnosis first, then Plant)
            const content = [
                'Plant Leaf Disease Analysis Report',
                '-------------------------------------',
                `Diagnosis: ${descFallback}`,
                `Details: ${explainText}`,
                `Suggested Cure: ${cureText}`,
                `Plant: ${plant}`,
                `Confidence Level: ${confidence}`,
                `Analysis Date/Time: ${timestamp}`,
                '',
                'Report Generated by Plant Leaf Disease Detector',
            ].join('\n');

            // Create a blob and trigger download
            try {
                const blob = new Blob([content], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `plant_disease_report_${new Date().getTime()}.txt`;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                }, 100);
            } catch (err) {
                console.error('Download failed:', err);
                alert('Could not generate report for download.');
            }
        }
    </script>
</body>
</html>
